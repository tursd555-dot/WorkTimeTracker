# Исправление проблемы с разлогиниванием из админки

## Проблема

Разлогинивание пользователей из административной панели не работало при использовании Supabase в качестве бэкенда.

## Причина

В файле `supabase_api.py` отсутствовали критические методы, необходимые для работы функции принудительного разлогинивания:

1. **`kick_active_session()`** - метод для установки статуса "kicked" в активной сессии
2. **`check_user_session_status()`** - метод для проверки статуса сессии пользователя
3. **`finish_active_session()`** - метод для завершения активной сессии
4. **`ack_remote_command()`** - метод для подтверждения получения удаленной команды
5. **`set_active_session()`** - метод для создания/обновления активной сессии

Также отсутствовали вспомогательные методы:
- `get_user_by_email()` - получение пользователя по email
- `delete_user()` - удаление пользователя
- `update_user_fields()` - обновление полей пользователя
- `log_user_actions()` - запись действий пользователя в лог
- `get_all_active_sessions()` - получение всех активных сессий

## Решение

Добавлены все недостающие методы в `supabase_api.py` с реализацией, совместимой с интерфейсом `sheets_api.py`.

### Добавленные методы:

#### 1. `kick_active_session()`
Принудительно завершает последнюю активную сессию пользователя, устанавливая статус "kicked" и команду "FORCE_LOGOUT".

#### 2. `check_user_session_status()`
Проверяет статус сессии пользователя. Возвращает: 'active', 'kicked', 'finished', 'expired', 'unknown'.

#### 3. `finish_active_session()`
Завершает активную сессию пользователя со статусом "finished".

#### 4. `ack_remote_command()`
Отправляет подтверждение получения удаленной команды (очищает поле `remote_command`).

#### 5. `set_active_session()`
Создает или обновляет активную сессию пользователя.

#### 6. Вспомогательные методы
- `get_user_by_email()` - получение пользователя по email
- `delete_user()` - пометка пользователя как неактивного
- `update_user_fields()` - обновление полей пользователя
- `log_user_actions()` - запись действий в лог
- `get_all_active_sessions()` - получение всех активных сессий

## Как работает разлогинивание

### Процесс:

1. **Админка** (`admin_app/repo.py`):
   - Вызывает `repo.force_logout(email)`
   - Который вызывает `sheets.kick_active_session(email, logout_time=...)`
   - Метод обновляет запись в таблице `active_sessions`, устанавливая:
     - `status = "kicked"`
     - `logout_time = <текущее время>`
     - `remote_command = "FORCE_LOGOUT"`

2. **User App** (`auto_sync.py`):
   - В каждом цикле синхронизации (каждые 10 секунд) вызывается `_check_remote_commands()`
   - Который проверяет статус сессии через `check_user_session_status(email, session_id)`
   - Если статус == "kicked":
     - Отправляется сигнал `force_logout` в GUI
     - Отправляется ACK подтверждение через `ack_remote_command()`
     - GUI получает сигнал и вызывает `force_logout_by_admin()`

3. **GUI** (`user_app/gui.py`):
   - Метод `force_logout_by_admin()`:
     - Блокирует все кнопки
     - Завершает текущий статус
     - Записывает LOGOUT в локальную БД
     - Отправляет данные в Sheets/Supabase
     - Обновляет ActiveSessions
     - Показывает сообщение и закрывает приложение через 10 секунд

## Проверка работы

После применения исправления:

1. Запустите user app и залогиньтесь
2. В админке выберите пользователя и нажмите "Разлогинить"
3. В течение 10 секунд (интервал синхронизации) user app должен:
   - Получить сигнал разлогинивания
   - Показать сообщение "Вы были разлогинены администратором"
   - Автоматически закрыться через 10 секунд

## Логи для отладки

При разлогинивании должны появиться следующие логи:

**В админке:**
```
INFO: Force logout success for <email>
```

**В user app:**
```
INFO: [ADMIN_LOGOUT] Обнаружен статус 'kicked' для пользователя <email>
INFO: ACK отправлен для команды kick пользователя <email>
INFO: [ADMIN_LOGOUT] Принудительный выход для <email>
INFO: [ADMIN_LOGOUT] LOGOUT записан в локальную БД
INFO: [ADMIN_LOGOUT] LOGOUT отправлен в Sheets
```

## Примечания

- Проверка статуса происходит в каждом цикле синхронизации (каждые 10 секунд в нормальном режиме)
- Если интернет недоступен, проверка будет выполняться реже, но при восстановлении связи сразу проверит статус
- Методы совместимы с интерфейсом `sheets_api.py`, поэтому код работает одинаково для обоих бэкендов
