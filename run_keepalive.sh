#!/bin/bash
################################################################################
# Supabase Keep-Alive - Linux/Mac –∑–∞–ø—É—Å–∫
################################################################################
#
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç "ping" Supabase –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   1. –ó–∞–ø—É—Å–∫ –≤—Ä—É—á–Ω—É—é: ./run_keepalive.sh
#   2. Cron (–∫–∞–∂–¥—ã–µ 3 –¥–Ω—è): 0 0 */3 * * /path/to/run_keepalive.sh
#
################################################################################

echo "================================================================================"
echo "Supabase Keep-Alive Script"
echo "================================================================================"
echo ""

# –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Python
if ! command -v python3 &> /dev/null; then
    echo "‚ùå ERROR: Python3 –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "   –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python: https://www.python.org/downloads/"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ supabase
python3 -c "import supabase" 2>/dev/null
if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è  WARNING: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ 'supabase' –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    echo "   –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é..."
    pip3 install supabase
    if [ $? -ne 0 ]; then
        echo "‚ùå ERROR: –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É!"
        exit 1
    fi
fi

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ keep-alive
echo "üîÑ –ó–∞–ø—É—Å–∫–∞—é keep-alive —Å–∫—Ä–∏–ø—Ç..."
echo ""
python3 "${SCRIPT_DIR}/supabase_keepalive.py"

if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå ERROR: –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ SUPABASE_URL –∏ SUPABASE_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ .env"
    exit 1
fi

echo ""
echo "================================================================================"
echo "‚úÖ –ì–û–¢–û–í–û! Supabase –ø—Ä–æ–µ–∫—Ç –∞–∫—Ç–∏–≤–µ–Ω."
echo "   –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: —á–µ—Ä–µ–∑ 3 –¥–Ω—è"
echo "================================================================================"
echo ""

exit 0
