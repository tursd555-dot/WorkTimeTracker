# Система Telegram уведомлений

## Описание

Реализована улучшенная система уведомлений в Telegram с дебаунсингом и правилами отправки.

## Требования и реализация

### 1. Уведомления в личку пользователю

**Требование:**
- Отправка при превышении перерыва/обеда на 1+ минуту
- Раз в 5 минут (дебаунсинг)
- До момента изменения статуса на продуктивный или завершения сессии

**Реализация:**
- Файл: `shared/break_notifications_v2.py`
- Функция: `send_overtime_notification()`
- Дебаунсинг: `_should_send_user_notification()` - проверяет, прошло ли 5 минут
- Сброс дебаунсинга:
  - При изменении статуса на продуктивный (`break_status_integration.py`)
  - При завершении перерыва (`break_status_integration.py`)
  - При logout (`break_status_integration.py`)

### 2. Уведомления в группу администраторов

**Требование:**
- Одно сообщение за нарушение
- Типы нарушений:
  1. Превышение лимита времени перерыва/обеда на 1+ минуту
  2. Перерыв/обед вне временного окна
  3. Превышение допустимого количества перерывов/обедов

**Реализация:**
- Функции:
  - `send_overtime_notification()` - превышение лимита времени
  - `send_out_of_window_notification()` - вне временного окна
  - `send_quota_exceeded_notification()` - превышение количества
- Дебаунсинг: `_should_send_group_notification()` - отслеживает отправленные уведомления по ключу нарушения

## Лимиты по умолчанию

- **Перерыв**: 15 минут
- **Обед**: 60 минут

Лимиты могут быть переопределены в графике пользователя (админка → Перерывы → Шаблоны).

## Порог уведомлений

- **Превышение**: 1+ минута (изменено с 2 минут)
- Настройка: `config.py` → `BREAK_OVERTIME_THRESHOLD = 1`

## Интеграция

### Автоматический мониторинг

Сервис `admin_app/break_monitor_service.py` автоматически проверяет активные перерывы каждую минуту и отправляет уведомления при превышении лимитов.

Сервис запускается автоматически при старте админки.

### Ручной вызов

Уведомления также отправляются:
- При завершении перерыва (если было превышение)
- При начале перерыва вне временного окна
- При попытке взять перерыв сверх лимита

## Тестирование

Запустите скрипт для тестирования:

```bash
python test_telegram_notifications.py
```

Скрипт проверяет:
1. ✅ Уведомления о превышении лимита
2. ✅ Уведомления о перерыве вне окна
3. ✅ Уведомления о превышении количества
4. ✅ Дебаунсинг личных уведомлений (5 минут)
5. ✅ Сброс дебаунсинга

**Важно:** Замените `test@example.com` на реальный email перед тестированием!

## Структура файлов

- `shared/break_notifications_v2.py` - новая система уведомлений
- `shared/break_notifications.py` - старая система (оставлена для совместимости)
- `admin_app/break_monitor_service.py` - сервис мониторинга перерывов
- `admin_app/break_manager.py` - интеграция уведомлений
- `shared/break_status_integration.py` - сброс дебаунсинга при изменении статуса
- `test_telegram_notifications.py` - скрипт тестирования

## Логирование

Все уведомления логируются:
- `INFO` - успешная отправка
- `DEBUG` - пропуск из-за дебаунсинга
- `WARNING` - ошибки отправки
- `ERROR` - критические ошибки

## Настройки

В `config.py`:
- `BREAK_OVERTIME_THRESHOLD = 1` - порог превышения для уведомлений (минуты)
- `BREAK_NOTIFY_USER_ON_VIOLATION = True` - уведомлять пользователя
- `BREAK_NOTIFY_ADMIN_ON_VIOLATION = True` - уведомлять админа

## Примеры сообщений

### В личку пользователю:
```
⚠️ ПРЕВЫШЕН ЛИМИТ ПЕРЕРЫВА

Ваш перерыв: 16 минут
Лимит: 15 минут
Превышение: +1 минут

Пожалуйста, вернитесь к работе.
```

### В группу администраторов:
```
⚠️ НАРУШЕНИЕ ЛИМИТА

Сотрудник: user@example.com
Тип: Перерыв
Длительность: 16 мин (лимит 15 мин)
Превышение: +1 мин
Время: 14:30:15
```
