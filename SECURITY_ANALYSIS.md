# –ê–Ω–∞–ª–∏–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ WorkTimeTracker

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-01-27  
**–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞:** 0.4.0

## üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –£–Ø–ó–í–ò–ú–û–°–¢–ò

### 1. –ñ–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –∫–æ–¥–µ

**–§–∞–π–ª:** `config.py:30`

```python
os.environ.setdefault("SUPABASE_KEY", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...")
```

**–ü—Ä–æ–±–ª–µ–º–∞:** API –∫–ª—é—á Supabase –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ. –î–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á, –æ–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

**–†–∏—Å–∫:** 
- –£—Ç–µ—á–∫–∞ –∫–ª—é—á–∞ –ø—Ä–∏ –∫–æ–º–º–∏—Ç–µ –≤ –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞
- –ù–∞—Ä—É—à–µ–Ω–∏–µ best practices –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å setdefault
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
SUPABASE_KEY = os.getenv("SUPABASE_KEY")
if not SUPABASE_KEY:
    raise ValueError("SUPABASE_KEY must be set in environment variables")
```

---

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ email –ø—Ä–∏ –≤—Ö–æ–¥–µ

**–§–∞–π–ª:** `user_app/login_window.py:186`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∞—Ç–∞ email, –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –≤ API –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω—ã SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ email (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–∞–ø—Ä—è–º—É—é).

**–†–∏—Å–∫:**
- SQL-–∏–Ω—ä–µ–∫—Ü–∏–∏ (–µ—Å–ª–∏ email –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ SQL –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏)
- XSS –∞—Ç–∞–∫–∏ —á–µ—Ä–µ–∑ email –≤ UI
- NoSQL –∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ Supabase

**–†–µ—à–µ–Ω–∏–µ:**
```python
def _sanitize_email(self, email: str) -> str:
    """–°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è email –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"""
    email = email.strip().lower()
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
    if any(char in email for char in [';', '--', '/*', '*/', 'union', 'select']):
        raise ValueError("Invalid email format")
    return email
```

---

### 3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –¥–ª—è Telegram –±–æ—Ç–∞

**–§–∞–π–ª:** `telegram_bot/main.py:107-145`

**–ü—Ä–æ–±–ª–µ–º–∞:** Telegram –±–æ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ —á–∞—Å—Ç–æ—Ç–µ. –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞ –∏ DDoS.

**–†–∏—Å–∫:**
- –ó–ª–æ–Ω–∞–º–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞—Å–ø–∞–º–∏—Ç—å –±–æ—Ç–∞
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ rate limits Telegram API
- –û—Ç–∫–∞–∑ –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏ (DoS)

**–†–µ—à–µ–Ω–∏–µ:**
```python
from collections import defaultdict
from time import time

_rate_limit_cache = defaultdict(list)
RATE_LIMIT_WINDOW = 60  # —Å–µ–∫—É–Ω–¥
RATE_LIMIT_MAX_REQUESTS = 10

def check_rate_limit(chat_id: int) -> bool:
    now = time()
    requests = _rate_limit_cache[chat_id]
    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    requests[:] = [req_time for req_time in requests if now - req_time < RATE_LIMIT_WINDOW]
    
    if len(requests) >= RATE_LIMIT_MAX_REQUESTS:
        return False
    
    requests.append(now)
    return True
```

---

### 4. –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö credentials

**–§–∞–π–ª:** `config.py:152-158`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å credentials —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ—á–∏—Ç–∞–Ω—ã –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏.

**–†–∏—Å–∫:**
- –ß—Ç–µ–Ω–∏–µ credentials –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å–∏—Å—Ç–µ–º—ã
- –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∫—Ä–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:**
```python
import stat
import os

with tempfile.NamedTemporaryFile(mode='wb', suffix='.json', delete=False) as tmp:
    tmp.write(json_bytes)
    tmp_name = Path(tmp.name)
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü –º–æ–∂–µ—Ç —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å
    os.chmod(tmp_name, stat.S_IRUSR | stat.S_IWUSR)
```

---

## üü† –í–´–°–û–ö–ò–ï –†–ò–°–ö–ò

### 5. Race condition –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–π

**–§–∞–π–ª:** `user_app/login_window.py:192-196`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –¥–≤–∞ —à–∞–≥–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –¥—Ä—É–≥–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.

**–†–∏—Å–∫:**
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π
- –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Å—Å–∏—è—Ö
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∏–ª–∏ –∞—Ç–æ–º–∞—Ä–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é
def finish_existing_and_create_new(email: str, new_session_id: str):
    """–ê—Ç–æ–º–∞—Ä–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é –∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é"""
    with db.write_tx():
        # –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        db.execute("""
            UPDATE work_sessions 
            SET status='finished', logout_time=? 
            WHERE email=? AND status='active'
        """, (datetime.now(), email))
        
        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
        db.execute("""
            INSERT INTO work_sessions (email, session_id, login_time, status)
            VALUES (?, ?, ?, 'active')
        """, (email, new_session_id, datetime.now()))
```

---

### 6. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Supabase API

**–§–∞–π–ª:** `supabase_api.py:301-400`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `_append_row_to_table` –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤. –û—Å–æ–±–µ–Ω–Ω–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è UUID –∏ –¥–∞—Ç.

**–†–∏—Å–∫:**
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–∞–∑–µ
- –û—à–∏–±–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –í–æ–∑–º–æ–∂–Ω—ã–µ –∏–Ω—ä–µ–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ:**
```python
import uuid
from datetime import datetime

def _validate_uuid(value: str) -> str:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è UUID"""
    try:
        uuid.UUID(value)
        return value
    except ValueError:
        raise ValueError(f"Invalid UUID format: {value}")

def _validate_email(value: str) -> str:
    """–í–∞–ª–∏–¥–∞—Ü–∏—è email"""
    email = value.strip().lower()
    if not re.match(r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$', email):
        raise ValueError(f"Invalid email format: {value}")
    return email
```

---

### 7. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `supabase_api.py:391`)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –ª–æ–≥–∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è email –∞–¥—Ä–µ—Å–∞, session_id –∏ –¥—Ä—É–≥–∏–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏.

**–†–∏—Å–∫:**
- –£—Ç–µ—á–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –ª–æ–≥–∏
- –ù–∞—Ä—É—à–µ–Ω–∏–µ GDPR/–∑–∞–∫–æ–Ω–æ–≤ –æ –∑–∞—â–∏—Ç–µ –¥–∞–Ω–Ω—ã—Ö
- –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏—è —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

**–†–µ—à–µ–Ω–∏–µ:**
```python
import logging

class SensitiveDataFilter(logging.Filter):
    """–§–∏–ª—å—Ç—Ä –¥–ª—è –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–≥–∞—Ö"""
    
    def filter(self, record):
        if hasattr(record, 'msg'):
            # –ú–∞—Å–∫–∏—Ä—É–µ–º email
            record.msg = re.sub(
                r'([a-zA-Z0-9._%+-]+)@([a-zA-Z0-9.-]+)\.([a-zA-Z]{2,})',
                r'\1***@\2.***',
                str(record.msg)
            )
            # –ú–∞—Å–∫–∏—Ä—É–µ–º session_id
            record.msg = re.sub(
                r'session_id[=:]\s*([a-zA-Z0-9_-]+)',
                r'session_id=***',
                str(record.msg)
            )
        return True

logger.addFilter(SensitiveDataFilter())
```

---

### 8. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

**–§–∞–π–ª:** `admin_app/main_admin.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –æ–ø–µ—Ä–∞—Ü–∏–π. –õ—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∏–º–µ—é—â–∏–π –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é, –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è.

**–†–∏—Å–∫:**
- –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º
- –£–¥–∞–ª–µ–Ω–∏–µ/–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def require_admin(func):
    """–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤"""
    def wrapper(self, *args, **kwargs):
        current_user = self.get_current_user()
        if not current_user or current_user.get('role') != 'admin':
            raise PermissionError("Admin access required")
        return func(self, *args, **kwargs)
    return wrapper

@require_admin
def on_delete_user_clicked(self):
    # ...
```

---

## üü° –°–†–ï–î–ù–ò–ï –†–ò–°–ö–ò

### 9. –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**–§–∞–π–ª:** `sheets_api.py:231-326`

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Å–ª–∏—à–∫–æ–º —à–∏—Ä–æ–∫–æ (`except Exception`), —á—Ç–æ —Å–∫—Ä—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –∑–∞—Ç—Ä—É–¥–Ω—è–µ—Ç –æ—Ç–ª–∞–¥–∫—É.

**–†–∏—Å–∫:**
- –°–∫—Ä—ã—Ç–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫
- –ü–ª–æ—Ö–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
try:
    result = func(*args, **kwargs)
except gspread.exceptions.APIError as e:
    if e.response.status_code == 429:
        # Rate limit - retry
        raise SheetsAPIError("Rate limit exceeded", is_retryable=True)
    elif e.response.status_code == 404:
        # Not found - don't retry
        raise SheetsAPIError("Resource not found", is_retryable=False)
    else:
        raise
except requests.exceptions.Timeout:
    raise SheetsAPIError("Request timeout", is_retryable=True)
except Exception as e:
    logger.error(f"Unexpected error: {e}", exc_info=True)
    raise SheetsAPIError(f"Unexpected error: {e}", is_retryable=False)
```

---

### 10. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª:** `supabase_api.py:666-693`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `_get_all_values_from_table` –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π. –ü—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä–µ–º–µ –¥–∞–Ω–Ω—ã—Ö —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é –ø–∞–º—è—Ç–∏.

**–†–∏—Å–∫:**
- –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
- –ú–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –û—Ç–∫–∞–∑ –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
MAX_ROWS_PER_REQUEST = 10000

def _get_all_values_from_table(self, table_name: str, limit: int = None) -> List[List[Any]]:
    """–ü–æ–ª—É—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º"""
    query = self.client.table(table_name).select('*')
    
    if limit:
        query = query.limit(limit)
    elif self._estimate_table_size(table_name) > MAX_ROWS_PER_REQUEST:
        logger.warning(f"Table {table_name} is too large, limiting to {MAX_ROWS_PER_REQUEST} rows")
        query = query.limit(MAX_ROWS_PER_REQUEST)
    
    response = query.execute()
    # ...
```

---

### 11. –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

**–§–∞–π–ª:** `config.py:152`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `tempfile.mkstemp`, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ race conditions.

**–†–∏—Å–∫:**
- Race conditions –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ñ–∞–π–ª–æ–≤
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –¥—Ä—É–≥–∏–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏

**–†–µ—à–µ–Ω–∏–µ:**
```python
import tempfile
import os

fd, tmp_path = tempfile.mkstemp(suffix='.json', dir=tempfile.gettempdir())
try:
    with os.fdopen(fd, 'wb') as tmp:
        tmp.write(json_bytes)
        os.chmod(tmp_path, 0o600)  # –¢–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü
    yield Path(tmp_path)
finally:
    try:
        os.unlink(tmp_path)
    except OSError:
        pass
```

---

### 12. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç CSRF

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç CSRF —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –º–µ–∂—Å–∞–π—Ç–æ–≤—ã—Ö –∞—Ç–∞–∫. –•–æ—Ç—è —ç—Ç–æ desktop –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –Ω–æ –ø—Ä–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ.

**–†–∏—Å–∫:**
- CSRF –∞—Ç–∞–∫–∏ –ø—Ä–∏ –≤–µ–±-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–†–µ—à–µ–Ω–∏–µ:**
```python
import secrets

class CSRFProtection:
    def __init__(self):
        self._tokens = {}
    
    def generate_token(self, session_id: str) -> str:
        token = secrets.token_urlsafe(32)
        self._tokens[session_id] = token
        return token
    
    def validate_token(self, session_id: str, token: str) -> bool:
        return self._tokens.get(session_id) == token
```

---

### 12. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è SQL-–∏–Ω—ä–µ–∫—Ü–∏—è —á–µ—Ä–µ–∑ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

**–§–∞–π–ª:** `shared/db/encrypted_database.py:213, 281, 380`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ SQL —á–µ—Ä–µ–∑ f-string –±–µ–∑ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.

```python
self.conn.execute(f"PRAGMA key = '{self.encryption_key}'")
```

**–†–∏—Å–∫:**
- –ï—Å–ª–∏ –∫–ª—é—á —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏, SQL –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–º–∞–Ω
- –¢–µ–æ—Ä–µ—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–º–æ–∂–Ω–∞ –∏–Ω—ä–µ–∫—Ü–∏—è (—Ö–æ—Ç—è –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –¥–ª—è PRAGMA)

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏–ª–∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
import sqlite3

# –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–µ—Å–ª–∏ SQLite –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–ª—è PRAGMA)
# –í–∞—Ä–∏–∞–Ω—Ç 2: –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
safe_key = self.encryption_key.replace("'", "''")
self.conn.execute(f"PRAGMA key = '{safe_key}'")

# –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ SQLite
self.conn.execute(f"PRAGMA key = ?", (self.encryption_key,))
```

---

### 13. –í—ã–≤–æ–¥ —á–∞—Å—Ç–∏ —Å–µ–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞ –≤ –ª–æ–≥–∏

**–§–∞–π–ª:** `api_adapter.py:108`

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –æ—Ç–ª–∞–¥–æ—á–Ω—ã—Ö —Ü–µ–ª—è—Ö –≤—ã–≤–æ–¥–∏—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ –∫–ª—é—á–∞.

```python
print(f"Supabase KEY: {'***' + SUPABASE_KEY[-10:] if SUPABASE_KEY else 'NOT SET'}")
```

**–†–∏—Å–∫:**
- –£—Ç–µ—á–∫–∞ —á–∞—Å—Ç–∏ –∫–ª—é—á–∞ —á–µ—Ä–µ–∑ –ª–æ–≥–∏
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥—Ä—É–≥–∏—Ö –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ü–æ–ª–Ω–æ—Å—Ç—å—é –º–∞—Å–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á
print(f"Supabase KEY: {'***SET***' if SUPABASE_KEY else 'NOT SET'}")
# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ö–µ—à
import hashlib
if SUPABASE_KEY:
    key_hash = hashlib.sha256(SUPABASE_KEY.encode()).hexdigest()[:8]
    print(f"Supabase KEY: ***{key_hash}***")
```

---

## üîµ –õ–û–ì–ò–ß–ï–°–ö–ò–ï –û–®–ò–ë–ö–ò

### 14. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ UUID –≤ Supabase API

**–§–∞–π–ª:** `supabase_api.py:225-242, 326-375`

**–ü—Ä–æ–±–ª–µ–º–∞:** –õ–æ–≥–∏–∫–∞ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è UUID –≤ –∏–º—è —à–∞–±–ª–æ–Ω–∞ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏ –æ—à–∏–±–∫–∞–º.

**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥:
```python
def _resolve_schedule_identifier(self, identifier: str) -> tuple[str, str]:
    """
    –†–∞–∑—Ä–µ—à–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —à–∞–±–ª–æ–Ω–∞ (UUID –∏–ª–∏ –∏–º—è) –≤ (UUID, name).
    Returns: (schedule_uuid, schedule_name)
    """
    uuid_pattern = re.compile(r'^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$', re.IGNORECASE)
    
    if uuid_pattern.match(identifier.strip()):
        # –≠—Ç–æ UUID, –ø–æ–ª—É—á–∞–µ–º –∏–º—è
        response = self.client.table('break_schedules')\
            .select('id, name')\
            .eq('id', identifier)\
            .limit(1)\
            .execute()
        if response.data:
            return response.data[0]['id'], response.data[0].get('name', identifier)
        raise ValueError(f"Schedule UUID not found: {identifier}")
    else:
        # –≠—Ç–æ –∏–º—è, –ø–æ–ª—É—á–∞–µ–º UUID
        response = self.client.table('break_schedules')\
            .select('id, name')\
            .eq('name', identifier)\
            .limit(1)\
            .execute()
        if response.data:
            return response.data[0]['id'], response.data[0].get('name', identifier)
        raise ValueError(f"Schedule name not found: {identifier}")
```

---

### 15. –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π

**–§–∞–π–ª:** `supabase_api.py:518-555`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ `end_time` –∏ `duration` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –Ω–æ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã (None, "null", "None").

**–†–µ—à–µ–Ω–∏–µ:**
```python
def _is_empty_value(self, value: Any) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ"""
    if value is None:
        return True
    if isinstance(value, str):
        return value.strip() == "" or value.strip().lower() in ("null", "none", "nil")
    return False

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
if not self._is_empty_value(end_time_str):
    # –æ–±—Ä–∞–±–æ—Ç–∫–∞
```

---

### 16. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

**–§–∞–π–ª:** `supabase_api.py:401-476`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —à–∞–±–ª–æ–Ω–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–ª–æ—Ç–∞–º–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –ü—Ä–∏ –æ—à–∏–±–∫–µ —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# Supabase –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ RPC
def create_schedule_with_slots(self, schedule_data: dict, slots: list):
    """–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω —Å–æ —Å–ª–æ—Ç–∞–º–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏"""
    try:
        # –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–ø–∏—Å—å
        main_response = self.client.table('break_schedules').insert({
            'name': schedule_data['name'],
            'shift_start': schedule_data['shift_start'],
            'shift_end': schedule_data['shift_end'],
            'is_active': True
        }).execute()
        
        schedule_id = main_response.data[0]['id']
        
        # –°–æ–∑–¥–∞–µ–º —Å–ª–æ—Ç—ã
        slot_records = []
        for slot in slots:
            slot_records.append({
                'name': schedule_data['name'],
                'schedule_id': schedule_id,  # –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å
                'description': json.dumps(slot),
                'is_active': True
            })
        
        if slot_records:
            self.client.table('break_schedules').insert(slot_records).execute()
        
        return True
    except Exception as e:
        logger.error(f"Failed to create schedule: {e}")
        # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è (—É–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–ø–∏—Å—å –µ—Å–ª–∏ —Å–æ–∑–¥–∞–ª–∞—Å—å)
        if 'schedule_id' in locals():
            try:
                self.client.table('break_schedules').delete().eq('id', schedule_id).execute()
            except:
                pass
        raise
```

---

## üí° –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ

### 17. –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç–∏–Ω–≥

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Sentry –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (Prometheus + Grafana)
- –ê–ª–µ—Ä—Ç—ã –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö

---

### 18. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ï—Å—Ç—å retry –ª–æ–≥–∏–∫–∞, –Ω–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
```python
from tenacity import retry, stop_after_attempt, wait_exponential, retry_if_exception_type

@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    retry=retry_if_exception_type((requests.exceptions.Timeout, requests.exceptions.ConnectionError))
)
def api_request(self, method, *args, **kwargs):
    # ...
```

---

### 19. –î–æ–±–∞–≤–∏—Ç—å unit-—Ç–µ—Å—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ï—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –Ω–æ –ø–æ–∫—Ä—ã—Ç–∏–µ –Ω–µ–ø–æ–ª–Ω–æ–µ.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
- Unit-—Ç–µ—Å—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è API
- –¢–µ—Å—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (fuzzing, SQL injection tests)

---

### 20. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
- OpenAPI/Swagger —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è API
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

---

### 21. –£–ª—É—á—à–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:** –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–∞ –ø–æ —Ñ–∞–π–ª–∞–º.

**–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:**
```python
# config/settings.py
from pydantic import BaseSettings, validator

class Settings(BaseSettings):
    supabase_url: str
    supabase_key: str
    telegram_bot_token: str
    log_level: str = "INFO"
    
    @validator('supabase_key')
    def validate_supabase_key(cls, v):
        if not v or len(v) < 20:
            raise ValueError("Invalid Supabase key")
        return v
    
    class Config:
        env_file = '.env'
        env_file_encoding = 'utf-8'

settings = Settings()
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏:** 4
- **–í—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏:** 4
- **–°—Ä–µ–¥–Ω–∏–µ —Ä–∏—Å–∫–∏:** 6 (–¥–æ–±–∞–≤–ª–µ–Ω—ã –ø.12, –ø.13)
- **–õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:** 3
- **–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:** 5

---

## ‚úÖ –ü–†–ò–û–†–ò–¢–ï–¢–´ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ:**
   - –£–¥–∞–ª–∏—Ç—å –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã (–ø.1)
   - –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é email (–ø.2)
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ —Å–µ—Å—Å–∏—è—Ö (–ø.5)

2. **–í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è:**
   - Rate limiting –¥–ª—è Telegram –±–æ—Ç–∞ (–ø.3)
   - –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ (–ø.4)
   - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ Supabase API (–ø.6)

3. **–í —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏:**
   - –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–í—ã—Å–æ–∫–∏–µ —Ä–∏—Å–∫–∏"
   - –õ–æ–≥–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
   - –£–ª—É—á—à–µ–Ω–∏—è –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ "–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

–ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ (Circuit Breaker, retry –ª–æ–≥–∏–∫–∞, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ). –û–¥–Ω–∞–∫–æ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ç—Ä–µ–±—É—é—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —Å–ª–µ–¥—É–µ—Ç —É–¥–µ–ª–∏—Ç—å:

1. –£–¥–∞–ª–µ–Ω–∏—é —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏–∑ –∫–æ–¥–∞
2. –í–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
3. –ó–∞—â–∏—Ç–µ –æ—Ç race conditions
4. –£–ª—É—á—à–µ–Ω–∏—é –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
