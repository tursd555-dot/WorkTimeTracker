# Инструкция по сборке WorkTimeTracker для Windows

## Описание

Скрипт `build_windows.py` собирает все компоненты WorkTimeTracker в portable приложения для Windows, которые:
- ✅ Работают без прав администратора
- ✅ Не требуют установки Python или зависимостей
- ✅ Готовы к отправке (один ZIP архив)
- ✅ Работают "из коробки"

## Собираемые компоненты

1. **WorkTimeTracker_User** - Пользовательская часть
2. **WorkTimeTracker_Admin** - Админка
3. **WorkTimeTracker_Monitor** - Реал тайм монитор
4. **WorkTimeTracker_Bot** - Телеграм бот

## Требования

### Системные требования
- Windows 10/11
- Python 3.10 или выше
- PyInstaller: `pip install pyinstaller`

### Необходимые файлы проекта
- `config.py` - конфигурация
- `user_app/` - пользовательская часть
- `admin_app/` - админка
- `telegram_bot/` - телеграм бот
- `shared/` - общие модули
- `sync/` - модули синхронизации
- `notifications/` - модули уведомлений

### Опциональные файлы
- `secret_creds.zip` - учетные данные (если используются)
- `.env` - переменные окружения (если используются)

## Установка зависимостей

```bash
# Установка PyInstaller
pip install pyinstaller

# Установка всех зависимостей проекта
pip install -r requirements.txt
```

## Сборка всех компонентов

### Быстрая сборка (все компоненты)

```bash
python build_windows.py
```

Скрипт:
1. Проверит наличие необходимых файлов
2. Очистит старые сборки
3. Соберет все 4 компонента
4. Создаст ZIP архив со всеми приложениями

### Результат

После успешной сборки вы получите:

```
dist/
├── WorkTimeTracker_User/
│   └── WorkTimeTracker_User.exe
├── WorkTimeTracker_Admin/
│   └── WorkTimeTracker_Admin.exe
├── WorkTimeTracker_Monitor/
│   └── WorkTimeTracker_Monitor.exe
└── WorkTimeTracker_Bot/
    └── WorkTimeTracker_Bot.exe

WorkTimeTracker_Windows_YYYYMMDD_HHMMSS.zip  # Архив со всеми приложениями
```

## Сборка отдельных компонентов

Если нужно собрать только один компонент, можно использовать PyInstaller напрямую или создать отдельный скрипт.

### Пример сборки пользовательской части

```bash
pyinstaller --name=WorkTimeTracker_User ^
    --onedir ^
    --windowed ^
    --clean ^
    --paths=. ^
    --add-data=config.py;. ^
    --add-data=user_app;user_app ^
    --add-data=shared;shared ^
    --add-data=sync;sync ^
    --add-data=notifications;notifications ^
    --hidden-import=PyQt5.sip ^
    --hidden-import=gspread ^
    user_app/main.py
```

## Структура собранного приложения

Каждое приложение собирается в директорию со структурой:

```
WorkTimeTracker_User/
├── WorkTimeTracker_User.exe  # Главный исполняемый файл
├── _internal/                 # Внутренние файлы PyInstaller
│   ├── python310.dll
│   ├── PyQt5/
│   ├── gspread/
│   └── ... (все зависимости)
└── ... (другие файлы)
```

## Использование собранных приложений

### Пользовательская часть
1. Запустите `WorkTimeTracker_User.exe`
2. Приложение работает полностью автономно
3. Все данные сохраняются локально

### Админка
1. Запустите `WorkTimeTracker_Admin.exe`
2. Требуются права доступа к Google Sheets или Supabase
3. Убедитесь, что `config.py` настроен правильно

### Реал тайм монитор
1. Запустите `WorkTimeTracker_Monitor.exe`
2. Откроется окно мониторинга статусов
3. Обновление происходит автоматически

### Телеграм бот
1. Запустите `WorkTimeTracker_Bot.exe`
2. Бот будет работать в консольном режиме
3. Убедитесь, что `TELEGRAM_BOT_TOKEN` настроен в `.env` или `config.py`

## Отправка приложений

### Вариант 1: ZIP архив
Скрипт автоматически создает ZIP архив со всеми приложениями. Просто отправьте файл `WorkTimeTracker_Windows_YYYYMMDD_HHMMSS.zip`.

### Вариант 2: Отдельные папки
Можно отправить папки из `dist/` по отдельности. Каждая папка - это полностью рабочее приложение.

## Устранение проблем

### Ошибка "ModuleNotFoundError"
Если при запуске EXE возникает ошибка отсутствия модуля:
1. Добавьте модуль в `COMMON_HIDDEN_IMPORTS` в `build_windows.py`
2. Пересоберите приложение

### Ошибка "FileNotFoundError"
Если приложение не находит файл:
1. Убедитесь, что файл добавлен через `--add-data`
2. Проверьте путь к файлу в коде (используйте `sys._MEIPASS` для PyInstaller)

### Большой размер EXE
- Это нормально для PyQt5 приложений
- Размер обычно 50-150 MB на приложение
- Можно использовать `--onefile` вместо `--onedir`, но это медленнее запускается

### Антивирус блокирует EXE
- PyInstaller иногда вызывает ложные срабатывания
- Добавьте папку в исключения антивируса
- Или подпишите EXE цифровой подписью (требует сертификат)

## Дополнительные опции PyInstaller

Если нужно настроить сборку, можно изменить параметры в `build_windows.py`:

- `--onefile` - один EXE файл (вместо папки)
- `--console` - показать консоль (для отладки)
- `--noupx` - не использовать UPX сжатие
- `--debug=all` - включить отладочную информацию

## Логи сборки

Все логи сохраняются в `build_all.log`. При проблемах проверьте этот файл.

## Поддержка

При возникновении проблем:
1. Проверьте `build_all.log`
2. Убедитесь, что все зависимости установлены
3. Проверьте, что все необходимые файлы присутствуют
4. Попробуйте собрать компонент отдельно для диагностики
